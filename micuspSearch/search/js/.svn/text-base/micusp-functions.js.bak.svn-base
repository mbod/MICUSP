/* 
-------------------------------------------------------------------


  Functions used in the MICUSP Simple online search interface

  Version 0.1 - Aug. 2009



-------------------------------------------------------------------
*/

	// THESE ARE GLOBAL VARIABLES 

	var plot, plot2,percentdata;
	var init = 1;
	var deptselect=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
	var typeselect=[0,0,0,0,0,0,0,0];
	var deptExpand=false;
	var typeExpand=false;

	var typeName=Array();
	typeName['CaseStudy']=0;
	typeName['Critique']=1;
	typeName['LiteratureReview']=2;
	typeName['ResearchProposal']=3;
	typeName['ResponsePaper']=4;
	typeName['TechnicalOrLabReport']=5;
	typeName['TermPaper']=6;
	typeName['OtherTextType']=7;

	var depts = [
                                        [0.5, 'BIO'], [1.5, 'CEE'], [2.5, 'ECO'],
                                        [3.5, 'EDU'], [4.5, 'ENG'], [5.5, 'HIS_CLS'],
                                        [6.5, 'IOE'], [7.5, 'LIN'], [8.5, 'MEC'],
                                        [9.5, 'NRE'], [10.5, 'NUR'], [11.5, 'PHI'],
                                        [12.5, 'PHY'], [13.5, 'POL'], [14.5, 'PSY'],
                                        [15.5, 'SOC'] 

			];



        var percentdata = [
                                        	{ label: 'CaseStudy', data: 0},
                                        	{ label: 'Critique', data: 0},
                                        	{ label: 'LiteratureReview', data: 0},
                                        	{ label: 'ResearchProposal', data: 0},
                                        	{ label: 'ResponsePaper', data: 0},
                                        	{ label: 'TechnicalOrLabReport', data: 0},
                                        	{ label: 'TermPaper', data: 0}, 
                                        	{ label: 'OtherTextType', data: 0}
						
                                ];


	var d2=Array(deptselect.length);






// =====================================================================
// *** deptSelect ***
// function to highlight and unhighlight bars
// in the histogram using flags in the deptselect array
// =====================================================================
function deptSelect(series, barpos){

    //alert('In deptSelect: series - ' + series + ' barpos - ' + barpos + ' d2 - ' + d2);

       if (barpos>-1) {
              if (deptselect[barpos] == 1) {
                     deptselect[barpos]=0;
              } else {
                     deptselect[barpos]=1;
              }
        }

        for (var i=0; i<deptselect.length; i++) {
              if (deptselect[i]==1) {
                      plot.highlight(series,d2[i]);
              } else {
                      plot.unhighlight(series,d2[i]);
	      }

	}
    
    
                     
}
// ######  end of function deptSelect #########



// =================================
// *** updateHistogram ***
// =================================
function updateHistogram(){

	var numOfTypes = percentdata.length;
	var numOfDepts = deptselect.length;

    var data=[];

    
    for(var i=0; i< numOfDepts;i++){
         data[i] = 0;
    }

        for(var i=0; i<numOfTypes;i++){
                if(typeselect[i]==1 || $("#typeNo").attr('checked')==true) {
                        for(var j=0; j < numOfDepts; j++){
                                data[j] = data[j]+deptTypeData[j][i];
                        }

                }
        }

        for(var i=0; i < numOfDepts; i++){
            d2[i] = [i,data[i]];
        }
   
        plot = $.plot(  $("#histogram"), 
			    [{data: d2 , bars: {show: true, clickable: true }}],
                            { xaxis: { ticks: depts}, yaxis: { max: 110 }, grid: { clickable: true, hoverable: false },
                              selection: { mode: "y", color: "#ff0000"}
			  } 
			);

	//alert('highlight histogram');
	highlightHistogram();

     if (init) {
	     $("#histogram").bind("plotclick", function (event, pos, item) {
	       if (item) {

	            /*
				if(deptExpand == false){
					//$("INPUT[type='checkbox']").attr('checked',false);
					$("#deptbody").slideToggle(600);
					deptExpand = true;
					//$("#deptNo").attr('checked',false);
				}
	            */

				//alert('calling deptSelect from histogram callback ' + event + ' ' + pos + ' ' + item);
				deptSelect(item.series, item.datapoint[0]);
				var i = 0;
	            var numberSelected = 0;
				$(".deptcheck").each(
					function(){
						if(i == item.datapoint[0]){
							if($(this).attr('checked') == true){
								$(this).attr('checked',false);
							}
							else{
								$(this).attr('checked',true);
        	                    $("#deptNo").attr('checked',false);
	                        }
						}
						i++;
	                    if (deptselect[i]) { numberSelected++; }
					}
				);
            
            
	            // if all departments are unselected then select deptNo
        	    if (numberSelected == 0) { $("#deptNo").attr('checked',true); }
				//$(".optionbody").slideToggle(600);
				showNumSelectedMessage();
				updatePieGraph();
        	 }
		
	     });
	}

	init = 0;
};
// ###################### end of function updateHistogram ############################




// =================================
// *** updatePieGraph ***
// =================================
function updatePieGraph(){
	var numOfTypes = percentdata.length;
	var numOfDepts = deptselect.length;
	//var data=new Array(numOfTypes);
	var data=[];

    
	var sum=0;
    
    
	for(var i=0; i< numOfTypes;i++){
		data[i] = 0;
	}
    
    

	for(var i=0; i<numOfDepts; i++){
		if(deptselect[i] == 1 || $("#deptNo").attr('checked')==true) {
			for(var j=0; j < numOfTypes; j++){
				data[j] = data[j]+deptTypeData[i][j];
				sum = sum + deptTypeData[i][j];
			}
			//alert(i+','+j+','+data[j]+','+deptTypeData[i][j]);

		}
	}
	for(var i=0; i<numOfTypes; i++){
		data[i] = data[i]/sum;
	}

	for(var i=0; i < numOfTypes; i++){
		percentdata[i]['data'] = data[i];
	}

        plot2 = $.plot($("#piegraph"),percentdata,
        {
                series:{
                        pie: {
                        show: true,
                        radius:110,
                        label: {
                                show: true,
                                radius: 3/4,
                                formatter: function(label, series){
                                return '<div id="'+label+'" class="pieClass" style="font-size:8pt;text-align:center;padding:2px;color:white;">'+label+'<br/>'+Math.round(series.percent)+'%</div>';
                        },
                                background: {
                                        opacity: 0.5,
                                        color: '#000'
                                }
                        }
                        }
                },
                legend: {
                        show: false
                }
        });

        $(".pieClass").click(function(){
                //$("#pieTermPaper").effect("highlight");
                //var cssObj = {'color':'black','background-color':'white'}
                var id = this.id;
                toggleLabel(id);
    
                typeselect[typeName[id]]=typeselect[typeName[id]] ? 0 : 1;

                /*
                if(typeExpand == false){
                        $("#typebody").slideToggle(600);
                        //$("INPUT[type='checkbox']").attr('checked',false);
                        //$("#typeNo").attr('checked',false);
                        typeExpand = true;
                }
                */
                
                
                var i=0;
                var numberSelected=0;
                $(".typecheck").each(
                        function(){
                                if($(this).val() == id){
                                        if($(this).attr('checked') == true){
                                                $(this).attr('checked',false);
                                        }
                                        else{
                                                $(this).attr('checked',true);
                                                $("#typeNo").attr('checked',false);
                                        }
                                }
                                i++;
                                if (typeselect[i]) { numberSelected++; }
                        }
                        
                );
                
                // if all paper types are unselected then select typeNo
                if (numberSelected == 0) { $("#typeNo").attr('checked',true); }
                
                //showNumSelectedMessage();
                updateHistogram();
		//highlightHistogram();
		showNumSelectedMessage();
        });
	//update highlighing
	highlightPieChart();
}
// ###################### end of function updatePieGraph ############################




function deptNoCheckEvent(){
	if($(this).attr('checked') == true){
	var i = 0;
	$(".deptcheck").each(
                function(){
                        //alert($(this).attr('checked'));
			$(this).attr('checked',false);
			deptselect[i] = 0;
			i++;
                }
        );	
	//		deptCheckEvent();
        //$(this).attr('checked',true);
		highlightHistogram();
		updatePieGraph();
	}
	else{
		$(this).attr('checked',false);
	}
	showNumSelectedMessage();
}
// ###################### end of function deptNoCheckEvent ############################


function typeNoCheckEvent(){
        if($(this).attr('checked') == true){
		var i = 0;
        	$(".typecheck").each(
                function(){
                        //alert($(this).attr('checked'));
                        $(this).attr('checked',false);
			typeselect[i] = 0;
			i++;
                }
        	);
        //	typeCheckEvent();
		highlightPieChart();
		
        
        updateHistogram();
        }
	else{
		$(this).attr('checked',false);
	}
	showNumSelectedMessage();
}
// ###################### end of function typeNoCheckEvent ############################



function showNumSelectedMessage(){
	var numSelectDept = 0;
	$(".deptcheck").each(
			function(){
                        if($(this).attr('checked') == true){
                            numSelectDept++;
                        }
             }
        );
	var numSelectType = 0;
        $(".typecheck").each(
                        function(){
                                        if($(this).attr('checked') == true){
                                                numSelectType++;
                                        }
                        }
        );	
	if(numSelectDept > 0 && numSelectType > 0){
	$("#graphinfo").html("Graph info: you have selected "+numSelectDept+" disciplines and "+numSelectType+" paper types. Please select disciplines and paper types before you click search button.");
	}
	else if(numSelectDept > 0){
	$("#graphinfo").html("Graph info: you have selected "+numSelectDept+" disciplines. Please select disciplines and paper types before you click search button.");
	}
	else if(numSelectType > 0){
	$("#graphinfo").html("Graph info: you have selected "+numSelectType+" paper types. Please select disciplines and paper types before you click search button.");
	}
	else{
	$("#graphinfo").html("Graph info: you don't put any restriction on the corpus.");
	}
}
// ###################### end of function showNumSelectedMessage ############################


function unhighlightLabel(id){
        $("#"+id).css('background-color','transparent');
        $("#"+id).css('color','white');
}
// ###################### end of function unhighlightLabel ############################


function highlightLabel(id){
        $("#"+id).css('background-color','gold');
        $("#"+id).css('color','black');
}
// ###################### end of function highlightLabel ############################


function toggleLabel(id){
	var color = $("#"+id).css('color');
	if(color == 'black'){
		unhighlightLabel(id);
	}
	else{
		highlightLabel(id);
	}
}
// ###################### end of function toggleLabel ############################


function highlightHistogram(){
 
	// is it better to use the deptselect variable
	// instead of checking the UI? 
       var i =0;
	var selectedI = 0;
        //var selectindex = 0;
        $(".deptcheck").each(
                function(){
                        //alert($(this).attr('checked'));
                        if($(this).attr('checked') == true){
				plot.highlight(0,i);
				deptselect[i] = 1;
				/*
                                if(deptselect[i]==0){
                                      	deptselect[i] = 1;
                                        deptSelect(0,i);
                                }
				*/
				selectedI++;
                        }
                        else{
			/*	
                                if(deptselect[i]==1){
                                 	deptselect[i] = 0;
                                        deptSelect(0,i);
                                } */
				deptselect[i] = 0;
				plot.unhighlight(0,i);
                        }
                        i++;
                }
        );
	if(selectedI == 0){
		$("#deptNo").attr('checked',true);
	//	deptNoCheckEvent();
	}
	//showNumSelectedMessage();
}
// ###################### end of function highlightHistogram ############################


function highlightPieChart(){
	var i =0;
	var selectedI = 0;
       $(".typecheck").each(
                function(){
                        //type_str=type_str+$(this).val()+", ";
                        //$type[$type.length++]=$(this).val();
                        if($(this).attr('checked') == true){
                                highlightLabel($(this).val());
				typeselect[i] = 1;
				selectedI++;
                        }
                        else{
                                unhighlightLabel($(this).val());
				typeselect[i] = 0;
                        }
			i++;
                }
        );
	if(selectedI == 0){
		$("#typeNo").attr('checked',true);
		//typeNoCheckEvent();
	}
}
// ###################### end of function highlightPieChart ############################


function deptCheckEvent() {
        //var dept_str = "";
	//$().trigger('');
	//var dept=[];

	$("#deptNo").attr('checked',false);
	highlightHistogram();
	updatePieGraph();
	showNumSelectedMessage();
}
// ###################### end of function deptCheckEvent ############################


function typeCheckEvent(){
        var numtype;
	/*
        $(".typecheck").each(
                function(){
                        //type_str=type_str+$(this).val()+", ";
			//$type[$type.length++]=$(this).val();
                        if($(this).attr('checked') == true){
				highlightLabel($(this).val());
                        }
                        else{
				unhighlightLabel($(this).val());
                        }
                }
        );
	*/
	$("#typeNo").attr('checked',false);
	highlightPieChart();
	
	updateHistogram();
	showNumSelectedMessage();
}
// ###################### end of function typeCheckEvent ############################



/* ==========================

	UPDATE -- 

*/
function update(){

	//$("#histogram").html("<p><img src='/img/ajax-loader.gif'/></p>");

        $.post("/search/dept/",
        $("#searchform").serialize(),
	function(data) {
		$("#deptscript").html(data);   // *** THIS DOES NOT APPEAR TO WORK IN INTERNET EXPLORER **** 
	
		updatePieGraph();
		updateHistogram();		

		//deptSelect(0,-1);
	  }	
	);
	

	return;	

	/*

	var numdept = 0;

	var numpapers =0;
	var i = 0;
	for( i=0; i <d2.length;i++){
		if(d2[i][1]>0){	
			numdept++;
			numpapers += d2[i][1];
		}
	}
	//alert(d2[10][1]);	
	$("#numdept").html(" over "+numdept+" disciplines");
        var numtype = 0;    
        for(x in percentdata){
                numtype++;
        }
	
	$("#numtype").html(" and "+numtype+" paper types");	
        }
        );

	//update query info
	//$("#info").html($("#queryinfo").html()+"<div id=\"numdept\"></div>"+"<div id=\"numtype\"></div>. Results are displayed in order by discipline. View corpus graphs to see a normalized distribution of the results across disciplines and paper types.");
	//$("#info").fadeOut(800); //.fadeIn(800);
	$("#queryinfo").html("");
	//deptSelect(0,-1);

	*/

}
// ###################### end of function update ############################


function initMenu(){
	$(".optionbody").hide();
	$("#depthead").click(
                function(){
			if(deptExpand == true){
				deptExpand = false;
			}
			else{
				deptExpand = true;
			}
            
			//$("#deptbody").slideToggle(600);
                //        $(this).next('.optionbody').slideToggle(600);
                }
        );
        $("#typehead").click(
                function(){
                        if(typeExpand == true){
                                typeExpand = false;
                        }
                        else{
                                typeExpand = true;
                        }
                //        $("#typebody").slideToggle(600);
                //        $(this).next('.optionbody').slideToggle(600);
                }
        );
	/*
	$('.optionhead').click(
		function(){
			
			$(this).next('.optionbody').slideToggle(600);
		}
	);
	*/



}
// ###################### end of function initMenu ############################



function next(start,dir) {
                        if (dir=='+') {
                                dir=10;
                        } else {
                                dir=-10;
                        }

                        $.post('/search/tmp/',
                                $('#searchform').serialize()+"&start="+ (start+dir),
                                function(data) { $("#text").html(data); 
					$("#queryinfo").html("");
				}
                        );
			$("#queryinfo").html("");
                }
// ###################### end of function next ############################



function search() {

		$("#text").html("<p><img src='/img/ajax-loader.gif'/></p>");


                 $.post('/search/tmp/',
                              		$("#searchform").serialize(),
                                	function(data) {
                                        	$("#text").html(data);

	$("#info").html($("#queryinfo").html()+"<div id=\"numdept\"></div>"+"<div id=\"numtype\"></div>. Results are displayed in order by discipline. View corpus graphs to see a normalized distribution of the results across disciplines and paper types.");
	$("#queryinfo").html("");

                                	}
 		);
	//	$("#queryinfo").html("");

		update();

}
// ###################### end of function search ############################

