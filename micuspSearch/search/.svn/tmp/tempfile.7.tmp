from django.http import HttpResponse
from django.shortcuts import render_to_response, get_object_or_404
from view_cache_utils import cache_page_with_prefix

import urllib, urllib2
import xml.dom.minidom as mdom
import re

from lxml import etree


# for each discipline a tuple of paper numbers and total token count
dept_size = {
'BIO': (67,174112), 
'CEE': (31,98213), 
'ECO': (25,77668),
'EDU': (46,149099), 
'ENG': (98,265396), 
'HIS_CLS': (40,180523), 
'IOE': (42,124527), 
'LIN': (41,154160), 
'MEC': (32,122176), 
'NRE': (62,173071), 
'NUR': (42,157785), 
'PHI': (44,127290), 
'PHY': (21,44866), 
'POL': (62,208223), 
'PSY': (104,322808), 
'SOC': (72,214087) 
}

<<<<<<< .mine
def summary(request):
	url = "http://localhost:4444/exist/rest/db/MICUSP/queries/summary.xql"
=======
map_dept = { 
	'BIO': 0,
	'CEE': 1,
	'ECO': 2,
	'EDU': 3,
	'ENG': 4,
	'HIS': 5,
	'HIS_CLS': 5,
	'IOE': 6,
	'LIN': 7,
	'MEC': 8,
	'NRE': 9,
	'NUR': 10,
	'PHI': 11,
	'PHY': 12,
	'POL': 13,
	'PSY': 14,
	'SOC': 15
	}
>>>>>>> .r269


map_type = {
	'Report': 4,
	'Critique': 2,
	'ResearchPaper': 5,
	'Essay': 0,
	'ResponsePaper': 6,
	'CreativeWriting': 1,
	'Proposal': 3,
	'ResearchProposal': 3,
	}

<<<<<<< .mine
def simple(request):
	url = "http://localhost:4444/exist/rest/db/MICUSP/queries/distribution.xql"
=======
>>>>>>> .r269





def browse_key_prefix(request):
	
	include_params = ['q', 'level', 'feature', 'dept', 'type','sort', 'start', 'direction','howmany']

	#if not (request.GET and request.POST):
	#	return None	

	if request.GET:
		params = request.GET.lists() 	

	if request.POST:
		params = request.POST.lists()

	#params = filter(lambda x: x[0] in include_params, params)

	params.sort()
	return 'br-'+'_'.join(["%s=%s" % (i[0], '_'.join(i[1])) for i in params]).replace(' ','')


@cache_page_with_prefix(60 * 15, browse_key_prefix)
def browse(request):
	url = "http://localhost:4444/exist/rest/db/MICUSP/queries/browse.xql"
	sort=None
	direction={}
	if request.method=='POST':
		param={}
		if request.POST.has_key('dept'):
			param['dept']= request.POST.getlist('dept')

		if request.POST.has_key('type'):
			param['type'] = request.POST.getlist('type')


		if request.POST.has_key('feature'):
			param['feature'] = request.POST.getlist('feature')


		if request.POST.has_key('level'):
			param['level'] = request.POST.getlist('level')


		if request.POST.has_key('start'):
			param['start'] = request.POST['start']
		
		if request.POST.has_key('howmany'):
			param['howmany'] = request.POST['howmany']

		if request.POST.has_key('sort'):
			param['sort'] = request.POST['sort']
			sort=request.POST['sort']

		if request.POST.has_key('direction'):
			dir = request.POST['direction']
			param['direction'] = dir
			direction['img'] = dir == 'asc' and '/search/img/up.png' or '/search/img/down.png'
			direction['alt'] = dir == 'asc' and 'Sort ascending' or 'Sort descending'

		data = urllib.urlencode(param,doseq=1)
		
		r=urllib2.urlopen(url,data)


	elif request.method=='GET':
		param={}
		if request.GET.has_key('dept'):
			param['dept']= request.GET.getlist('dept')

		if request.GET.has_key('type'):
			param['type'] = request.GET.getlist('type')


		if request.GET.has_key('feature'):
			param['feature'] = request.GET.getlist('feature')


		if request.GET.has_key('level'):
			param['level'] = request.GET.getlist('level')


		if request.GET.has_key('start'):
			param['start'] = request.GET['start']
		
		if request.GET.has_key('howmany'):
			param['howmany'] = request.GET['howmany']

		if request.GET.has_key('sort'):
			param['sort'] = request.GET['sort']
			sort=request.GET['sort']

		if request.GET.has_key('direction'):
			dir = request.GET['direction']
			param['direction'] = dir
			direction['img'] = dir == 'asc' and '/search/img/up.png' or '/search/img/down.png'
			direction['alt'] = dir == 'asc' and 'Sort ascending' or 'Sort descending'

		

		data = urllib.urlencode(param,doseq=1)
		
		r=urllib2.urlopen(url,data)

	else:
                r=urllib2.urlopen(url)


        results = []


        
        doc=mdom.parse(r).getElementsByTagName("results")[0]

	papers = doc.attributes['papers'].value

	start = doc.getElementsByTagName("paper")[0].attributes['num'].value

	last = papers == doc.getElementsByTagName("paper")[-1].attributes['num'].value

	paper_elements = doc.getElementsByTagName("paper")

        for d in paper_elements:
		results.append({'doc': d.attributes['doc'].value, 
				'title': d.getElementsByTagName('title')[0].firstChild.data,
                                'dept': d.getElementsByTagName('discipline')[0].firstChild.data,
				'type': d.getElementsByTagName('paperType')[0].firstChild.data,
				'paper_info': '''
						<table class="paper_info"><tbody>
						<tr><td class="label">Discipline:</td><td>%s</td></tr>
						<tr><td class="label">Student Level:</td><td>%s</td></tr>
						<tr><td class="label">Sex:</td><td>%s</td></tr>
						<tr><td class="label">Native speaker status:</td><td>%s</td></tr>
						<tr><td class="label">Paper type:</td><td>%s</td></tr>
						<tr><td class="label">Textual features:</td><td>%s</td></tr>
						</tbody></table>
					      '''
					% (d.getElementsByTagName('discipline')[0].firstChild.data,
					   d.getElementsByTagName('studentLevel')[0].firstChild.data,
					   d.getElementsByTagName('sex')[0].firstChild.data,
					   d.getElementsByTagName('nativeness')[0].firstChild.data,
					   d.getElementsByTagName('paperType')[0].firstChild.data,
					   d.getElementsByTagName('features')[0].firstChild.data)				
					
				})

        return render_to_response('browse.html',{'results':results, 'papers': papers, 
				  'start': start, 'num': len(paper_elements) + int(start) - 1, 
				  'last': last, 'sort': sort, 'direction': direction})



def dept_key_prefix(request):
	
	include_params = ['q', 'level', 'feature', 'dept', 'type','sort']

	#if not (request.GET and request.POST):
	#	return None	

	if request.GET:
		params = request.GET.lists() 	

	if request.POST:
		params = request.POST.lists()

	params = filter(lambda x: x[0] in include_params, params)

	params.sort()
	return 'dt-'+'_'.join(["%s=%s" % (i[0], '_'.join(i[1])) for i in params]).replace(' ','')


@cache_page_with_prefix(60 * 15, dept_key_prefix)
def dept(request):
<<<<<<< .mine
	url = "http://localhost:4444/exist/rest/db/MICUSP/queries/distribution.xql"
	url2 = "http://localhost:4444/exist/rest/db/MICUSP/queries/query2.xql"
=======
	url = "http://localhost:8080/exist/rest/db/MICUSP/queries/distribution.xql"
	url2 = "http://localhost:8080/exist/rest/db/MICUSP/queries/searchQuery.xql"
>>>>>>> .r269

	if request.method=='POST':
		param={'dept': request.POST.getlist('dept'), 'type': request.POST.getlist('type'), 
			'feature': request.POST.getlist('feature'), 'level': request.POST.getlist('level'),
			'q': '"%s"' % request.POST['q'].encode('UTF8')}
		data = urllib.urlencode(param,doseq=1)
		r=urllib2.urlopen(url,data)
		q2 = request.POST['q']


		#if q2!='':
		#	param['howmany']=-1
		#	data = urllib.urlencode(param,doseq=1)
		#	r2=urllib2.urlopen(url2,data)
		#	return HttpResponse(r2)

	elif request.method=='GET' and request.GET.has_key('q'):
		param={'dept': request.GET.getlist('dept'), 'type': request.GET.getlist('type'), 
			'feature': request.GET.getlist('feature'), 'level': request.GET.getlist('level'),
			'q': '"%s"' % request.GET['q'].encode('UTF8')}
		data = urllib.urlencode(param,doseq=1)
		r=urllib2.urlopen(url,data)
		q2 = request.GET['q']

	else:
                r=urllib2.urlopen(url)
                q2=''


        depts=[]
        doc=mdom.parse(r)
        deptType = []
        for d in doc.getElementsByTagName("dept"):
                typeList = []
                i = 0
                for t in d.childNodes:
                        if t.nodeName != '#text' and t.nodeName != 'total':
                                typeList.append(d.getElementsByTagName(t.nodeName)[0].firstChild.data)
                deptType.append(typeList)
	
        for d in doc.getElementsByTagName("dept"):
                depts.append(d.getElementsByTagName("total")[0].firstChild.data)
	
	return render_to_response('base_histogram.html', { 'points': depts, 'q': q2, 'deptType':deptType})


def type(request):
	typeurl = "http://localhost:4444/exist/rest/db/MICUSP/queries/type.xql"
	if request.method=='POST':
		typeparam={'type': request.POST.getlist('type'), 'dept': request.POST.getlist('dept'), 'q': '"%s"' % request.POST['q']
.encode('UTF8')}
		typedata = urllib.urlencode(typeparam,doseq=1)
                typer=urllib2.urlopen(typeurl,typedata)
		q2 = request.POST['q']
	else:
                q2=''
		typer=urllib2.urlopen(typeurl)
	types = []
	typedoc=mdom.parse(typer)
        for d in typedoc.getElementsByTagName("type"):
                types.append({'name': d.attributes['id'].value,'percent': d.getElementsByTagName("total")[
0].firstChild.data})
	return render_to_response('base_type.html', { 'types': types, 'q': q2 })	



def search_summary_key_prefix(request):
	
	include_params = ['q', 'level', 'feature']

	#if not (request.GET and request.POST):
	#	return None	

	if request.GET:
		params = request.GET.lists() 	

	if request.POST:
		params = request.POST.lists()

	params = filter(lambda x: x[0] in include_params, params)

	params.sort()
	return 'ss-'+'_'.join(["%s=%s" % (i[0], '_'.join(i[1])) for i in params]).replace(' ','')


@cache_page_with_prefix(60 * 15, search_summary_key_prefix)
def search_summary(request):
        url = "http://localhost:8080/exist/rest/db/MICUSP/queries/searchSummary.xql"
	url2 = "http://localhost:8080/exist/rest/db/MICUSP/queries/wordCounts.xql"

	data_frame = [

		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0]

	]

	token_frame = [

		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0],
		[0,0,0,0,0,0,0]
	];


	if request.method=='POST':
		param={ 'feature': request.POST.getlist('feature'),
			'level': request.POST.getlist('level'),
			'q': '"%s"' % request.POST['q'].encode('UTF8')}

		q2 = request.POST['q']

	elif request.method=='GET' and request.GET.has_key('q'):
		param={	'feature': request.GET.getlist('feature'),
			'level': request.GET.getlist('level'),
			'q': '"%s"' % request.GET['q'].encode('UTF8')}

		q2 = request.GET['q']


	else:
		return HttpResponse(data_frame)

	data = urllib.urlencode(param,doseq=1)
	r=urllib2.urlopen(url,data)

	r2=urllib2.urlopen(url2,data)

	results = etree.parse(r).xpath('//hit')

       	q2 = re.sub('([-,])','(\\1| )', re.sub(' ','[-,?!.:]?[ -]',q2.lower()))
 	
	qregex = re.compile('\\b(%s)\\b' % q2, re.IGNORECASE)

	#pid=None
	for result in results:
		dept = result.attrib['dept']
		type = result.attrib['type']
		#paper_id = result.attrib['id']
		#if pid!=paper_id:
		#	pid=paper_id
		#	token_frame[map_dept[dept]][map_type[type]]+=int(result.attrib['wc'])
		hits = len(re.findall(qregex,result.text))

		data_frame[map_dept[dept]][map_type[type]]+=hits

	depts = [ sum(r) for r in data_frame ]

	tokens = etree.parse(r2).xpath('//dept')
	for d in tokens:
		dept = d.attrib['id']
		for t in d.getchildren():
			ptype = t.attrib['id']
			token_frame[map_dept[dept]][map_type[ptype]]+=int(t.text)

	return render_to_response('base_histogram.html', { 'points': depts, 'q': q2, 'deptType':data_frame, 'token_frame': token_frame})

	#return HttpResponse(data_frame)

	
		




def main(request):
        url = "http://localhost:4444/exist/rest/db/MICUSP/queries/distribution.xql"
	typeurl = "http://localhost:4444/exist/rest/db/MICUSP/queries/type.xql"

        if request.method=='POST':
                param={'dept': '|'.join(request.POST.getlist('dept')), 'type': '|'.join(request.POST.getlist('type')),'q': '"%s"' % request.POST['q'].encode('UTF8')}

                data = urllib.urlencode(param)
                r=urllib2.urlopen(url,data)
                q2 = request.POST['q']
		#pie graph
		typeparam={'type': '|'.join(request.POST.getlist('type')),'dept': '|'.join(request.POST.getlist('dept')), 'q': '"%s"' % request.POST['q'].encode('UTF8')}
		typedata = urllib.urlencode(typeparam)
		typer=urllib2.urlopen(typeurl,typedata)
		
        else:
                r=urllib2.urlopen(url)
                q2=''
		#pie graph
		typer=urllib2.urlopen(typeurl)

        depts=[]
        doc=mdom.parse(r)

	deptType = []
	for d in doc.getElementsByTagName("dept"):
		typeList = []
		i = 0
		for t in d.childNodes:
			if t.nodeName != '#text' and t.nodeName != 'total':
				typeList.append(d.getElementsByTagName(t.nodeName)[0].firstChild.data)
		deptType.append(typeList)
	#return HttpResponse(typeList)
        for d in doc.getElementsByTagName("dept"):
                depts.append(d.getElementsByTagName("total")[0].firstChild.data)
		
        types=[]
        typedoc=mdom.parse(typer)
	
        for d in typedoc.getElementsByTagName("type"):
                types.append({'name': d.attributes['id'].value,'percent': d.getElementsByTagName("total")[0].firstChild.data})
        return render_to_response('base.html', { 'points': depts, 'types':types,'q': q2, 'r':r, 'deptType':deptType})
	#'dept': request.POST.getlist('dept') })
        #return render_to_response('base.html', { 'points': depts, 'q': q2, 'r': r })



def search_key_prefix(request):
	
	include_params = ['q', 'level', 'feature', 'dept', 'type','sort', 'start', 'direction','howmany']

	#if not (request.GET and request.POST):
	#	return None	

	if request.GET:
		params = request.GET.lists() 	

	if request.POST:
		params = request.POST.lists()

	#params = filter(lambda x: x[0] in include_params, params)

	params.sort()
	return 'sh-'+'_'.join(["%s=%s" % (i[0], '_'.join(i[1])) for i in params]).replace(' ','')


@cache_page_with_prefix(60 * 15, search_key_prefix)
def search(request):
        url = "http://localhost:4444/exist/rest/db/MICUSP/queries/query2.xql"
	param={}
	sort=None
	direction={}
	q=''
        if request.method=='POST':
                param={'q': '"%s"' % request.POST['q'].encode('UTF8')}

		if request.POST.has_key('dept'):
			param['dept']= request.POST.getlist('dept')
			#param['dept'] = request.POST.getlist('dept')[0:2]

		if request.POST.has_key('type'):
			param['type'] = request.POST.getlist('type')

		if request.POST.has_key('feature'):
			param['feature'] = request.POST.getlist('feature')

		if request.POST.has_key('level'):
			param['level'] = request.POST.getlist('level')

		if request.POST.has_key('start'):
			param['start'] = request.POST['start']
		
		if request.POST.has_key('howmany'):
			param['howmany'] = request.POST['howmany']


		if request.POST.has_key('sort'):
			param['sort'] = request.POST['sort']
			sort=request.POST['sort']

		if request.POST.has_key('direction'):
			dir = request.POST['direction']
			param['direction'] = dir
			direction['img'] = dir == 'asc' and '/search/img/up.png' or '/search/img/down.png'
			direction['alt'] = dir == 'asc' and 'Sort ascending' or 'Sort descending'


                data = urllib.urlencode(param,doseq=1)
                r=urllib2.urlopen(url,data)
                q=request.POST['q']


        elif request.method=='GET':
                param={'q': '"%s"' % request.GET['q'].encode('UTF8')}

		if request.GET.has_key('dept'):
			param['dept']= request.GET.getlist('dept')
			#param['dept'] = request.GET.getlist('dept')[0:2]

		if request.GET.has_key('type'):
			param['type'] = request.GET.getlist('type')

		if request.GET.has_key('feature'):
			param['feature'] = request.GET.getlist('feature')

		if request.GET.has_key('level'):
			param['level'] = request.GET.getlist('level')

		if request.GET.has_key('start'):
			param['start'] = request.GET['start']
		
		if request.GET.has_key('howmany'):
			param['howmany'] = request.GET['howmany']


		if request.GET.has_key('sort'):
			param['sort'] = request.GET['sort']
			sort=request.GET['sort']

		if request.GET.has_key('direction'):
			dir = request.GET['direction']
			param['direction'] = dir
			direction['img'] = dir == 'asc' and '/search/img/up.png' or '/search/img/down.png'
			direction['alt'] = dir == 'asc' and 'Sort ascending' or 'Sort descending'


                data = urllib.urlencode(param,doseq=1)
                r=urllib2.urlopen(url,data)
                q=request.GET['q']


        else:
		param['q'] = 'gold'
		data = urllib.urlencode(param)
                r=urllib2.urlopen(url,data)

        results = []

        doc=mdom.parse(r).getElementsByTagName("results")[0]

	papers = doc.attributes['papers'].value
        count = doc.attributes['count'].value

	try: 
		start = doc.getElementsByTagName("paper")[0].attributes['num'].value

		last = papers == doc.getElementsByTagName("paper")[-1].attributes['num'].value

        	q2 = re.sub('([-,])','(\\1| )', re.sub(' ','[-,?!.:]?[ -]',q.lower()))
 	
		qregex = re.compile('\\b(%s)\\b' % q2, re.IGNORECASE)
		total_hits=0

		for paper in doc.getElementsByTagName("paper"):
			hits=[]
			paper_hits=0
	        	for d in paper.getElementsByTagName("hit"):
	                	ptext = re.sub('</?p[^>]*>','',d.getElementsByTagName("p")[0].toxml())
				num_of_hits = len(qregex.findall(ptext))
				paper_hits+= num_of_hits
	                	ptext = re.sub(qregex,'<span class="query">\\1</span>', ptext.strip())  
				hits.append((num_of_hits,ptext))

			results.append({'doc': d.attributes['doc'].value, 
					'title': paper.attributes['title'].value, 
					'dept': paper.attributes['dept'].value,
					'type': paper.attributes['type'].value,
					'data': hits,
					'paper_hits' : paper_hits,
					'paper_info': '''
						<table class="paper_info"><tbody>
						<tr><td class="label">Discipline:</td><td>%s</td></tr>
						<tr><td class="label">Student Level:</td><td>%s</td></tr>
						<tr><td class="label">Sex:</td><td>%s</td></tr>
						<tr><td class="label">Native speaker status:</td><td>%s</td></tr>
						<tr><td class="label">Paper type:</td><td>%s</td></tr>
						<tr><td class="label">Textual features:</td><td>%s</td></tr>
						</tbody></table>
					      '''
					% (paper.attributes['dept'].value,
					   paper.getElementsByTagName('studentLevel')[0].firstChild.data,
					   paper.getElementsByTagName('sex')[0].firstChild.data,
					   paper.getElementsByTagName('nativeness')[0].firstChild.data,
					   paper.attributes['type'].value,
					   paper.getElementsByTagName('features')[0].firstChild.data)				

					})

			total_hits += paper_hits

	        return render_to_response('search_results.html', 
                                   {'results':results, 'papers': papers, 'count': count,
                                   'q': q, 'q2': q2, 'start': start, 'last': last, 
                                   'num' : len(results) + int(start) -1, 
				   'direction': direction, 'sort': sort,
				   'total_hits': total_hits
				})
	except:
		return HttpResponse('<div id="queryinfo">No results found. </div>')



def view(request):
        url = "http://localhost:4444/exist/rest/db/MICUSP/queries/view.xql"

	if request.GET:
		q2=''
		param = {
			 'pid': request.GET['pid'] }

		if request.GET.has_key('q'):
			q=request.GET['q']
			param['q']= '"%s"' % q
	        	q2 = re.sub('([-,])','(\\1| )', re.sub(' ','[-,?!.:]? ',q.lower()))



		data = urllib.urlencode(param)
                r=urllib2.urlopen(url,data)

	        doc=etree.parse(r)
		try:
			doc2=doc.xpath('//div[@id="text"]')[0]
		except:
			pass
		paras = doc2.xpath('//div[@id="text"]//p')

		for p in paras:
			if p.attrib.has_key('class'):
				
	                	p2 = etree.XML(re.sub('(?i)\\b(%s)\\b' % q2,'<span class="term">\\1</span>', etree.tostring(p)))
				p.getparent().replace(p,p2)

		pdiv=etree.tostring(doc2)
		hdiv=etree.tostring(doc.xpath('//div[@id="header"]')[0])

	else:
		pdiv="<div>NO PAPER FOUND</div>"
		hdiv=""

	return render_to_response('view_paper.html', {'paperHead': hdiv, 'paperDiv': pdiv, 'pid': request.GET['pid']})		





